<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mask Detection</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <h1>Mask Detection</h1>
    <canvas id="canvas" width="640" height="480"></canvas>
    <div id="debug"></div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const debugDiv = document.getElementById('debug');

        // Hidden video element for capturing frames
        const video = document.createElement('video');
        video.style.display = 'none';
        document.body.appendChild(video);

        // Access the camera
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
                video.play();
            })
            .catch(err => {
                console.error("Error accessing the camera", err);
                debugDiv.innerHTML += `<p>Error accessing the camera: ${err.message}</p>`;
            });

        function processFrame() {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/jpeg');

            axios.post('/process_image', { image: imageData })
                .then(response => {
                    const results = response.data;
                    debugDiv.innerHTML = `<p>Received results: ${JSON.stringify(results)}</p>`;
                    drawResults(results);
                })
                .catch(error => {
                    console.error("Error processing the image", error);
                    debugDiv.innerHTML += `<p>Error processing the image: ${error.message}</p>`;
                });
        }

        function drawResults(results) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            results.forEach(result => {
                const [x, y, w, h] = result.bbox;
                const color = result.class === 'Masked' ? 'green' : 'red';

                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, w, h);

                ctx.fillStyle = color;
                ctx.font = '16px Arial';
                ctx.fillText(`${result.class}: ${result.confidence.toFixed(2)}`, x, y - 5);
            });
        }

        // Process a frame every 500ms
        setInterval(processFrame, 500);
    </script>
</body>
</html>
